<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				DBUtils3の紹介 &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2015-05-26 06:43:47 &#43;0000 UTC">May 26, 2015</time>
</div>
		<h1 class="post-title">DBUtils3の紹介</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。</p>

<p>Javaでデータベースを使う場合、以下の２パターンが考えられます。</p>

<ol>
<li>ORMを使ってアクセスする</li>
<li>SELECT等のクエリを直接投げる</li>
</ol>

<p>DBUtils3はクエリを直接投げる際に多少楽になるように作ったライブラリです。</p>

<p><a href="https://github.com/tamurashingo/dbutils3/blob/master/README-ja.md">https://github.com/tamurashingo/dbutils3/blob/master/README-ja.md</a></p>

<!-- more -->

<h2 id="使い方">使い方</h2>

<h3 id="ライブラリのロード">ライブラリのロード</h3>

<p>Mavenを使っている場合は以下の5行を追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>  
    <span class="nt">&lt;groupId&gt;</span>com.github.tamurashingo.dbutil3<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>dbutil3<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>  </code></pre></div>
<h3 id="dbconnectionutilインスタンスの生成">DBConnectionUtilインスタンスの生成</h3>

<p>接続済みのConnectionを元に、DBConnectionUtil(ライブラリで使用するコネクション)を生成します。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">(</span><span class="n">DBConnectionUtil</span> <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DBConnectionUtil</span><span class="o">(</span><span class="n">connection</span><span class="o">))</span> <span class="o">{</span>  
<span class="o">}</span></code></pre></div>
<h3 id="sqlを発行する">SQLを発行する</h3>

<p>SQLを発行するにはプリコンパイル、実行の２工程が必要になります。
普通の<code>PreparedStatement</code>を使ったときの動きとほぼ同じです。</p>

<h4 id="プリコンパイル">プリコンパイル</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 参照系
</span><span class="c1"></span><span class="n">conn</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">&#34;select * from table where id = ?&#34;</span><span class="o">);</span>

<span class="c1">// 更新系
</span><span class="c1"></span><span class="n">conn</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">&#34;insert into table values(?, ?, ?)&#34;</span><span class="o">);</span>  </code></pre></div>
<h4 id="参照系sqlの実行">参照系SQLの実行</h4>

<p>参照系SQLを実行すると、その結果をJavaBeanで受け取ることができます。 JavaBeanを定義していない場合などは、<code>List&lt;Map&lt;String, String&gt;&gt;</code>で受け取ることもできます。
<code>executeQuery</code>を使って対応する<code>?</code>に対するパラメータをセットします。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// JavaBeanを生成する
</span><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">TestBean</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">TestBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">param1</span><span class="o">,</span> <span class="n">param2</span><span class="o">);</span>

<span class="c1">// Mapで受け取る
</span><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">param1</span><span class="o">,</span> <span class="n">param2</span><span class="o">);</span></code></pre></div>
<h4 id="更新系sqlの実行">更新系SQLの実行</h4>

<p>こちらは<code>executeUpdate</code>を使って、パラメータを指定します。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">,</span> <span class="s">&#34;value&#34;</span><span class="o">);</span></code></pre></div>
<h3 id="トランザクション制御">トランザクション制御</h3>

<p>自動コミットを切っていますので、更新系SQLを発行した後はコミットが必要になります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">{</span>  
    <span class="n">conn</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">);</span>
    <span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">conn</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">finally</span> <span class="o">{</span>  
    <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>
<h3 id="javabeanの定義">JavaBeanの定義</h3>

<p>参照結果をJavaBeanに変換するには、 JavaBeanの定義時にアノテーションでどの項目がどのカラムに対応するのかを定義する必要があります。
また、以下のJavaBean仕様に従う必要があります。</p>

<ul>
<li>public で引数無しのコンストラクタが必要

<ul>
<li>コピーコンストラクタ等を定義したい場合は、引数無しのコンストラクタも合わせて定義する必要があります</li>
</ul></li>
<li>メソッドの命名規則にしたがっていること(getter/setter)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBean</span> <span class="o">{</span>  
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&#34;test_id&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">testId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&#34;test_name&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">testName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TestBean</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">TestBean</span><span class="o">(</span><span class="n">TestBean</span> <span class="n">testBean</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">testId</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">testId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">testName</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">testName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestId</span><span class="o">(</span><span class="kt">int</span> <span class="n">testId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">testId</span> <span class="o">=</span> <span class="n">testId</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTestId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">testId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestName</span><span class="o">(</span><span class="n">String</span> <span class="n">testName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">testName</span> <span class="o">=</span> <span class="n">testName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTestName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">testName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h2 id="応用">応用</h2>

<p>JDBIというライブラリがあります。</p>

<p>JDBIでSELECT結果からJavaBeanを得るには自分でMapperを定義する必要があります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserBean</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">username</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDAO</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * get user-info with id.
</span><span class="cm">     *
</span><span class="cm">     * @param id id
</span><span class="cm">     * @return user-info
</span><span class="cm">     */</span>
    <span class="nd">@SingleValueResult</span><span class="o">(</span><span class="n">UserBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@SqlQuery</span><span class="o">(</span>
              <span class="s">&#34; select &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   id, &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   username, &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   password &#34;</span>
            <span class="o">+</span> <span class="s">&#34; from &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   user &#34;</span>
            <span class="o">+</span> <span class="s">&#34; where &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   id = :id &#34;</span>
    <span class="o">)</span>
    <span class="nd">@Mapper</span><span class="o">(</span><span class="n">UserJdbiMapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">UserBean</span><span class="o">&gt;</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>
<p>このようなBeanとDAOを定義した場合、SELECT結果のMapperはこんな感じになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserJdbiMapper</span> <span class="kd">implements</span> <span class="n">ResultSetMapper</span><span class="o">&lt;</span><span class="n">UserBean</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserBean</span> <span class="nf">map</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">StatementContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">UserBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserBean</span><span class="o">();</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">));</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>DBUtils3を使うと以下のように定義することができます。
カラム数が多いJavaBeanを扱うときに多少楽になります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserJdbiMapper</span> <span class="kd">implements</span> <span class="n">ResultSetMapper</span><span class="o">&lt;</span><span class="n">UserBean</span><span class="o">&gt;</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="n">BeanBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanBuilder</span><span class="o">(</span><span class="n">UserBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserBean</span> <span class="nf">map</span><span class="o">(</span><span class="kt">int</span> <span class="n">inex</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">StatementContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLExcetion</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UserBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">BeanBuilderException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">SQLException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h2 id="しくみ">しくみ</h2>

<h3 id="mapper">Mapper</h3>

<p>JavaBeanのフィールドで定義したColumnの名前とフィールドに対するsetterの組み合わせを保持するクラスです。
setterは<code>Mapper.AbstractSetter</code>を継承したインスタンスです。 フィールドの型に応じた値を<code>ResultSet</code>から取得し、フィールドにセットします。</p>

<p>このクラスは<code>BeanBuilder</code>を生成したタイミングで作成しています。</p>

<p>１つのJavaBeanに対して１回生成すればあとは使いまわせるため、<code>BeanBuilder</code>の生成は<code>BeanBuilderFactory</code>にて管理するようにしています。 そのため2回目以降の<code>BeanBuilder</code>の生成はちょっとだけ早いです。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">/// カラム名とsetterのマップ
</span><span class="c1"></span><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AbstractSetter</span><span class="o">&gt;</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

<span class="cm">/*-
</span><span class="cm"> * @Columnが指定されたフィールドを調べ、フィールドの型に応じたsetterをセットする
</span><span class="cm"> */</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Field</span> <span class="nl">field:</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">())</span> <span class="o">{</span>  
    <span class="cm">/*-
</span><span class="cm">     * フィールドから@Columnアノテーションを取得する
</span><span class="cm">     * アノテーションが取得できないフィールドはスキップ
</span><span class="cm">     */</span>
    <span class="kd">final</span> <span class="n">Column</span> <span class="n">column</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Column</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">column</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">continue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="cm">/*-
</span><span class="cm">         * フィールドからsetterメソッドを取得する
</span><span class="cm">         * setterがないフィールドはスキップ
</span><span class="cm">         * ! PropertyDescriptorを使っているためJavaの規約に準拠している必要があります
</span><span class="cm">         */</span>
        <span class="n">PropertyDescriptor</span> <span class="n">pd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDescriptor</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">cls</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Method</span> <span class="n">setter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="na">getWriteMethod</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">setter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">AbstractSetter</span> <span class="n">invoker</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// 
</span><span class="c1"></span>        <span class="n">mapper</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">column</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span> <span class="n">invoker</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">invoker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BooleanSetter</span><span class="o">(</span><span class="n">setter</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="kt">byte</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">invoker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteSetter</span><span class="o">(</span><span class="n">setter</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// ... 省略 ...
</span><span class="c1"></span>    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">IntrospectionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractSetter</span> <span class="o">{</span>  
    <span class="kd">protected</span> <span class="n">Method</span> <span class="n">setter</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="nf">AbstractSetter</span><span class="o">(</span><span class="n">Method</span> <span class="n">setter</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setter</span> <span class="o">=</span> <span class="n">setter</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">beanInst</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">SQLException</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">BooleanSetter</span> <span class="kd">extends</span> <span class="n">AbstractSetter</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nf">BooleanSetter</span><span class="o">(</span><span class="n">Method</span> <span class="n">setter</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">setter</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">beanInst</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">setter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">beanInst</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">columName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">ByteSetter</span> <span class="kd">extends</span> <span class="n">AbstractSetter</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nf">ByteSetter</span><span class="o">(</span><span class="n">Method</span> <span class="n">setter</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">setter</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">beanInst</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">setter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">beanInst</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">columName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h3 id="beanbuilder">`BeanBuilder</h3>

<p><code>ResultSet</code>をもとにJavaBeanを生成するクラスです。 コンストラクタに<code>Class</code>を渡し、そのタイミングで<code>Mapper</code>を生成しています。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span><span class="o">;</span>  
<span class="kd">private</span> <span class="n">Mapper</span> <span class="n">mapper</span><span class="o">;</span>

<span class="kd">public</span> <span class="nf">BeanBuilder</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">this</span><span class="o">.</span><span class="na">cls</span> <span class="o">=</span> <span class="n">cls</span><span class="o">;</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Mapper</span><span class="o">();</span>
    <span class="n">mapper</span><span class="o">.</span><span class="na">createMapper</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">build</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanBuilderException</span> <span class="o">{</span>  
    <span class="k">try</span> <span class="o">{</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
        <span class="n">T</span> <span class="n">bean</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">cls</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

        <span class="cm">/*-
</span><span class="cm">         * Mapperで定義したsetterを使って、ResultSetから値を取得しBeanにセットする。
</span><span class="cm">         *
</span><span class="cm">         */</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AbstractSetter</span><span class="o">&gt;</span> <span class="nl">entry:</span> <span class="n">mapper</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">AbstractSetter</span> <span class="n">setter</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">setter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">setter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">rs</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="o">|</span> <span class="n">InvocationTargetException</span> <span class="o">|</span> <span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 何かしら例外が出たらそのフィールドはnullにする
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="o">|</span> <span class="n">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanBuilderException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p><code>build</code>の宣言でGeneric Methodを使っています。 実際は以下のように<code>Object</code>型で宣言するのとほとんど同じなのですが、 使う側がキャストしなくてすむため、Generic Methodで宣言しています。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Generic Methodなしでの宣言
</span><span class="c1"></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">build</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="n">BeanBuilderException</span> <span class="o">{</span>  
    <span class="n">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>

    <span class="c1">// ... 省略 ...
</span><span class="c1"></span>
    <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">/// 使うとき
</span><span class="c1"></span>
<span class="c1">// Generic Methodあり
</span><span class="c1"></span><span class="n">TestBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">beanbuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">resultset</span><span class="o">);</span>

<span class="c1">// Generic Methodなし
</span><span class="c1"></span><span class="n">TestBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="o">(</span><span class="n">TestBean</span><span class="o">)</span><span class="n">beanbuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">resultset</span><span class="o">);</span>  </code></pre></div>
<h3 id="beanbuilderfactory">BeanBuilderFactory</h3>

<p>前述のとおり、<code>Mapper</code>や<code>BeanBuilder</code>は１つのJavaBeanに対して１回だけ作ればあとは使い回しが可能なため、 <code>Factory</code>クラスを作ってそこで生成の管理を行っています。</p>

<p>具体的には<code>Class</code>と<code>BeanBuilder</code>のマップを作り、<code>BeanBuilder</code>生成の要求がきたら作成済みかどうかを確認しています。 複数のスレッドから同じJavaBeanに対する生成要求がきた場合は<code>BeanBuilder</code>が上書きされる可能性がありますが、 以下の理由であえて無視しています。</p>

<ul>
<li>上書きされても結局は同じ動きをする<code>BeanBuilder</code>がマップに登録されるため</li>
<li><code>synchronized</code>をつけると普段の動作も遅くなってしまう。レアパターンに対応するよりは普段の動作速度の方が重要であるため</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">BeanBuilder</span><span class="o">&gt;</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>


<span class="nd">@Override</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">BeanBuilder</span> <span class="nf">getBeanBuilder</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">BeanBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">builder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanBuilder</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
        <span class="n">mapper</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
<h2 id="改善">改善</h2>

<p><code>BeanBuilderFactory</code>は生成要求があったタイミングで<code>BeanBuilder</code>を作っていますが、 起動時などにあらかじめ生成できると良いかなと思っています。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2015/04/14/maven-install/" class="left arrow">&#8592;</a>
		<a href="/posts/2015/06/10/dropwizard/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 22:08:13.866224 &#43;0900 JST m=&#43;0.432916631">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
