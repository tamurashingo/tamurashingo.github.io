<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Spring Frameworkを使ってみるpart4 &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2015-02-26 20:56:06 &#43;0000 UTC">February 26, 2015</time>
</div>
		<h1 class="post-title">Spring Frameworkを使ってみるpart4</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。
今回はDI(Dependency Injection)を使っていきます。</p>

<!-- more -->

<h2 id="目標">目標</h2>

<ul>
<li>サービスを定義する</li>
<li>サービスの実装を作る</li>
</ul>

<p>part3のソースをベースにしています。</p>

<h3 id="構成">構成</h3>

<p>このようなディレクトリ構成にします。</p>

<pre><code>rc/
  main/
    java/
      hello/
        AppConfig.java
        bean/
          GreetingBean.java
        controller/
            GreetingController.java
        service/
          GreetingService.java
          impl/
            GreetingServiceImpl.java
        init/
          Initializer.java
  resources/
    templates/
      greeting.html
      result.html
</code></pre>

<h2 id="サービスの定義">サービスの定義</h2>

<p>インターフェイスでサービスを定義します。 今回は入力した項目が正常かどうかをチェックするサービスを定義してみます。</p>

<p>src/main/java/hello/service/GreetingService.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">hello.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">hello.bean.GreetingBean</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GreetingService</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="n">GreetingBean</span> <span class="n">bean</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>
<h3 id="サービスの実装">サービスの実装</h3>

<p>上で定義したサービスを実装します。 普通に<code>implements</code>をつけて実装する他に、<code>@Component</code>アノテーションを付与します。</p>

<p>今回はidが0だったら入力エラーと判定するように作っています。</p>

<p>src/main/java/hello/service/impl/GreetingServiceImpl.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">hello.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">hello.bean.GreetingBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">hello.service.GreetingService</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreetingServiceImpl</span> <span class="kd">implements</span> <span class="n">GreetingService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="n">GreetingBean</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h2 id="サービスの呼び出し">サービスの呼び出し</h2>

<p>コントローラから呼び出すため、コントローラにサービスを持たせます。</p>

<p>src/main/java/hello/controller/GreetingController.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">hello.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">hello.bean.GreetingBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">hello.service.GreetingService</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreetingController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">GreetingService</span> <span class="n">greetingService</span><span class="o">;</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;/greeting&#34;</span><span class="o">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">greetingForm</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;greeting&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">GreetingBean</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">&#34;greeting&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;/greeting&#34;</span><span class="o">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">greetingSubmit</span><span class="o">(</span><span class="nd">@ModelAttribute</span> <span class="n">GreetingBean</span> <span class="n">greeting</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;greeting&#34;</span><span class="o">,</span> <span class="n">greeting</span><span class="o">);</span>

        <span class="c1">// part4で追加
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">greetingService</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">greeting</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;errmsg&#34;</span><span class="o">,</span> <span class="s">&#34;入力したIDが正しくありません&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">&#34;result&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p><code>@Autowired</code>アノテーションを付与することで、Springが自動的にインターフェイスに対する実装をセット(DI)してくれます。 この書き方でも良いのですが、単体試験をする際に自分でDIしなくてはいけないため、ちょっと面倒です。 私はsetterを用意するようにします。</p>

<p>※ setterよりもコンストラクタのほうがオススメ。コンストラクタの引数が多いということは、そのクラスに役割を多く持たせすぎていると判断できるため。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">private</span> <span class="n">GreetingService</span> <span class="n">greetingService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGreetingService</span><span class="o">(</span><span class="n">GreetingService</span> <span class="n">greetingService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">greetingService</span> <span class="o">=</span> <span class="n">greetingService</span><span class="o">;</span>
    <span class="o">}</span></code></pre></div>
<p><code>@Autowired</code>がついているメソッドでDIをやってくれます。非常に便利です。</p>

<h2 id="その他">その他</h2>

<h3 id="ビュー">ビュー</h3>

<p>エラーメッセージを表示するように変更します。</p>

<p>src/main/resources/templates/result.html</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&#34;http://www.thymeleaf.org&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Greeting Started: Handling Form Submission<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;Content-Type&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;text/html; charset=UTF-8&#34;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Result<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&#34;&#39;id: &#39; + ${greeting.id}&#34;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&#34;&#39;content: &#39; + ${greeting.content}&#34;</span> <span class="p">/&gt;</span>
    <span class="c">&lt;!-- エラーメッセージ --&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&#34;${errmsg}&#34;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&#34;@{/greeting}&#34;</span><span class="p">&gt;</span>Submit another message<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></code></pre></div>
<h3 id="bean">Bean</h3>

<p><code>Greeting.java</code>を<code>GreetingBean.java</code>に変更します。 パッケージも変更します。</p>

<p>src/main/java/hello/bean/GreetingBean.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">hello.bean</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreetingBean</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContent</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h2 id="実行">実行</h2>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">mvn clean package tomcat7:deploy</code></pre></div>
<p>でTomcatにデプロイして動きを確認します。 idに0を入れてsubmitした場合にエラーメッセージが出れば、今回追加したサービスが動いていることになります。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2015/02/25/bot-programming/" class="left arrow">&#8592;</a>
		<a href="/posts/2015/02/27/memo-with-org-mode/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 22:08:13.87083 &#43;0900 JST m=&#43;0.437521888">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
