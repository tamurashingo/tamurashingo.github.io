<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Ghostで少しだけ日本語を打ちやすくする &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2015-02-21 12:32:52 &#43;0000 UTC">February 21, 2015</time>
</div>
		<h1 class="post-title">Ghostで少しだけ日本語を打ちやすくする</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。
ある問題をちょっとだけ解決したので載せます。</p>

<!-- more -->

<h2 id="ghostの問題点">Ghostの問題点</h2>

<p>現在、Ghostでブログをやっていますが、</p>

<p><a href="http://devlog.forkwell.com/2014/09/01/setup-ghost-on-digitalocean/">http://devlog.forkwell.com/2014/09/01/setup-ghost-on-digitalocean/</a></p>

<p>にもあるように、IME変換中の文字が分かりにくいという問題があります。 0.6で直す！とのことですが、今現在は0.5.8でして本格的に対応されるのはもう少し先になりそうです。</p>

<h2 id="とりあえず直せないか">とりあえず直せないか？</h2>

<p>エディタ部分は CodeMirror を使っているので、 CodeMirror の実装がどうなっているかを見に行きます。 その前に Issue を確認します。ありました。 （この他にもIME関連で「下線が出ない」系のIssueが結構あがっていました。とりあえず落ち着け状態）</p>

<p><a href="https://github.com/codemirror/CodeMirror/issues/1513/">No underline while composing double-byte characters with IME. #1513</a></p>

<p>中を見ていくとプルリクエストもあるようです。</p>

<p>Adding markers while composing text #1382</p>

<p>pull request</p>

<p>ただ、まだいろいろなブラウザでの挙動がテストし切れていないということで、取り込まれていないようです。</p>

<h2 id="とりあえず直す">とりあえず直す</h2>

<p>プルリクエストがあるので、手元のGhostに取り込んでみます。</p>

<h3 id="ghostの再インストール">Ghostの再インストール</h3>

<p>前回はビルド済みのzipファイルを落としてきましたが、GitHubからコードを落としてきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/TryGhost/Ghost.git
<span class="nb">cd</span> Ghost
npm install</code></pre></div>
<h3 id="パッチの適用">パッチの適用</h3>

<p>行数が少ないので手でコピペして対応しました。 まずはJS側。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">vi bower_components/codemirror/lib/codemirror.js</code></pre></div>
<p><code>function fastPoll(cm)</code>の中に書いていきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">missed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">p</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">readInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">missed</span><span class="p">)</span> <span class="p">{</span><span class="nx">missed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nx">p</span><span class="p">);}</span>
      <span class="k">else</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composing</span><span class="p">)</span> <span class="nx">p</span><span class="p">();</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">p</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>
<p>続いて<code>function readInput(cm)</code>の中です。これは最後の<code>return</code>の直前に入れればいいのでわかりやすいです。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript">    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">updateInput</span> <span class="o">=</span> <span class="nx">updateInput</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">||</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;\n&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">withOp</span><span class="p">)</span> <span class="nx">endOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">pasteIncoming</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastCompositionEventData</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span> <span class="p">{</span><span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;CodeMirror-composing&#39;</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastCompositionEventData</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span> <span class="p">{</span><span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;CodeMirror-composing&#39;</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>
<p>続いて<code>function registerEventHandlers(cm)</code>の中です。イベントハンドラを登録しているところに追加していきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript">    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">fastPoll</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;keydown&#34;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onKeyDown</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;keypress&#34;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onKeyPress</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;focus&#34;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">onFocus</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;blur&#34;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">onBlur</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;compositionstart&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">onCompositionEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;compositionupdate&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">onCompositionEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;compositionend&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">onCompositionEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span> <span class="p">});</span>
</code></pre></div>
<p>最後に<code>function onBlur(cm)</code>の後ろあたりに新しい関数を追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">onBlur</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&#34;blur&#34;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">focused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34; CodeMirror-focused&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">blinker</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span> <span class="mi">150</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">onCompositionEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s2">&#34;compositionstart&#34;</span><span class="o">:</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&#34;compositionupdate&#34;</span><span class="o">:</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastCompositionEventData</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&#34;compositionend&#34;</span><span class="o">:</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">lastComposeMark</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">composeStart</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
<p>これでJS側の修正は完了です。</p>

<p>続いてCSS側。 CSSはSassを修正します。
適当なところに <code>.CodeMirror-composing</code> を入れておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">vi core/client/assets/sass/vendor/codemirror.scss</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-css" data-lang="css"><span class="p">.</span><span class="nc">CodeMirror-composing</span> <span class="p">{</span>
  <span class="k">border-bottom</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span> <span class="kc">solid</span> <span class="kc">black</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h3 id="動作確認">動作確認</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">grunt init
npm start</code></pre></div>
<p>EDIT画面でIME入力中に下線が出ることを確認します。
ちゃんと未決定の部分に下線が出ます。</p>

<h2 id="技術">技術</h2>

<h3 id="dom-level3-events">DOM Level3 Events</h3>

<p>Composition Eventを使ってIME入力の開始、終了を検知しています。
<a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-compositionevents">http://www.w3.org/TR/DOM-Level-3-Events/#events-compositionevents</a></p>

<p>各イベントが発火した時点でこのような処理を行っています。</p>

<ul>
<li><p>compositionstart検出（IME入力の開始）</p>

<ul>
<li>composingステータスをtrueに</li>
<li>入力開始位置を現在のカーソル位置から取得</li>
</ul></li>

<li><p>compositionupdate検出（IME入力中・変換中）</p>

<ul>
<li>入力中の文字を取得</li>
</ul></li>

<li><p>compositionend検出（IME入力の完了）</p>

<ul>
<li>composingステータスをfalseに</li>
<li>マーカーをオフに</li>
</ul></li>
</ul>

<p>あとはcomposingステータスの状態に応じて下線を引くCSSを有効にしていたりします。 なので 「わたしのなまえはなかのです」 を変換させて途中途中で確定させようとすると分からなくなります。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2015/02/21/septeni-scala-1/" class="left arrow">&#8592;</a>
		<a href="/posts/2015/02/24/springframework-01/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 21:56:01.457797 &#43;0900 JST m=&#43;0.544127661">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
