<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				CommonLispでREPLを使った開発 &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2015-02-13 23:20:38 &#43;0000 UTC">February 13, 2015</time>
</div>
		<h1 class="post-title">CommonLispでREPLを使った開発</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。</p>

<h2 id="動機">動機</h2>

<p>REPLを使った開発がどれくらい効率が良いか実際にやってみました。</p>

<p>例としてbase64エンコーダを作っていきます。 ロジックはウィキペディアに書いてあります。
<a href="http://ja.wikipedia.org/wiki/Base64">http://ja.wikipedia.org/wiki/Base64</a></p>

<!-- more -->

<p>一度qiitaにもbase64エンコーダを書いたのですが無駄が多かったため作り直しました。 (<a href="http://qiita.com/tamurashingo@github/items/fd3a56b0d6b8d40ed74c">http://qiita.com/tamurashingo@github/items/fd3a56b0d6b8d40ed74c</a>)</p>

<h2 id="文字列を数値の列にしたい">文字列を数値の列にしたい</h2>

<p>文字を数値に変換するのは char-code が使えます。ここら辺は適当にググリます。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">char-code</span> <span class="sc">#\\a</span><span class="p">)</span>
<span class="nv">97</span></code></pre></div>
<p>文字列をコードの列にするにはmap系を使えば良さそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mapcar</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abc&#34;</span><span class="p">)</span>
<span class="nv">The</span> <span class="nv">value</span> <span class="s">&#34;abc&#34;</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">expected</span> <span class="nv">type</span> <span class="nv">LIST.</span>
   <span class="nv">[Condition</span> <span class="nv">of</span> <span class="nv">type</span> <span class="nv">TYPE-ERROR]</span>

<span class="c1">; Evaluation aborted on #&lt;TYPE-ERROR #x2100E7FB3D&gt;.</span></code></pre></div>
<p>mapcarはリストにしか使えないのでmapを使います。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdef&#34;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">97</span> <span class="mi">98</span> <span class="mi">99</span> <span class="mi">100</span> <span class="mi">101</span> <span class="mi">102</span><span class="p">)</span></code></pre></div>
<h2 id="ビット演算をしたい">ビット演算をしたい</h2>

<h3 id="先頭の6ビットの取り出し">先頭の6ビットの取り出し</h3>

<p>まず先頭の6ビットを取り出します。たぶん<code>ldb</code>と<code>byt</code>eを組み合わせて使うはずです。
<a href="http://www.gigamonkeys.com/book/practical-parsing-binary-files.html">http://www.gigamonkeys.com/book/practical-parsing-binary-files.html</a>
ここらへんとかを見た感じだと。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~8,&#39;0b&#34;</span> <span class="mi">97</span><span class="p">)</span>
<span class="s">&#34;01100001&#34;</span></code></pre></div>
<p>ここから
<code>011000</code>
を抜き出したいです。</p>

<p>下2桁を除けばいいので</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">8</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">97</span><span class="p">)</span>
<span class="mi">24</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">8</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">97</span><span class="p">))</span>
<span class="s">&#34;011000&#34;</span></code></pre></div>
<p>でいけました。</p>

<h3 id="次の6ビットの取り出し">次の6ビットの取り出し</h3>

<p>97の先頭6ビットを抜き出すと残りは2ビットなので、次の文字を持ってきます。</p>

<h4 id="残りの2ビットの取り出し">残りの2ビットの取り出し</h4>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">97</span><span class="p">)</span>
<span class="mi">1</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~2,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">97</span><span class="p">))</span>
<span class="s">&#34;01&#34;</span></code></pre></div>
<h4 id="次のビットとの合成">次のビットとの合成</h4>

<p>残りの2ビットは8ビット分左へシフトします。 そして論理和を取れば10ビットになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">97</span><span class="p">)</span> <span class="mi">8</span><span class="p">)</span>
                 <span class="mi">98</span><span class="p">)</span>
<span class="mi">354</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~10,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">97</span><span class="p">)</span> <span class="mi">8</span><span class="p">)</span>
                                       <span class="mi">98</span><span class="p">))</span>
<span class="s">&#34;0101100010&#34;</span></code></pre></div>
<h3 id="先頭6ビットの取得">先頭6ビットの取得</h3>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">10</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">354</span><span class="p">)</span>
<span class="mi">22</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">10</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">354</span><span class="p">))</span>
<span class="s">&#34;010110&#34;</span></code></pre></div>
<p>のこりはこうなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">4</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">354</span><span class="p">)</span>
<span class="mi">2</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~4,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="mi">4</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">354</span><span class="p">))</span>
<span class="s">&#34;0010&#34;</span></code></pre></div>
<h2 id="複数の文字を処理したい">複数の文字を処理したい</h2>

<p>以上の結果から</p>

<p>先頭6ビットの取り出し</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">ビット長</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">ビット長</span> <span class="mi">6</span><span class="p">))</span> <span class="nv">全ビット</span><span class="p">)</span></code></pre></div>
<p>残り</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">ビット長</span> <span class="mi">6</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">全ビット</span><span class="p">)</span></code></pre></div>
<p>でループさせれば複数の文字を処理できそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abc&#34;</span><span class="p">)</span>
      <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
      <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
      <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
               <span class="ss">:do</span>
                 <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                        <span class="c1">;; 先頭6ビット</span>
                        <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                   <span class="c1">;; 6ビット表示</span>
                   <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~6,&#39;0b(~d)~%&#34;</span> <span class="nv">6bit</span> <span class="nv">6bit</span><span class="p">)</span>
                   <span class="c1">;; 残り</span>
                   <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                   <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)))))</span></code></pre></div>
<p>こんな感じに</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abc&#34;</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
            <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                  <span class="nv">do</span>
                    <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                           <span class="c1">;; 先頭6ビット</span>
                           <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                      <span class="c1">;; 6ビット表示</span>
                      <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~6,&#39;0b(~d)~%&#34;</span> <span class="nv">6bit</span> <span class="nv">6bit</span><span class="p">)</span>
                      <span class="c1">;; 残り</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)))))</span>

<span class="mi">011000</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="mi">010110</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="mi">001001</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="mi">100011</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
<span class="nv">NIL</span></code></pre></div>
<h2 id="あまりに対応したい">あまりに対応したい</h2>

<p>3文字だったら <code>8 x 3 = 24 → 24 / 6 = 4</code> であまりが出ませんが、2文字等の場合はあまりが出ます。
あまりが出たら0で埋めて6bitにする必要があります。</p>

<p><code>bitlen</code>が1の場合 -&gt; 5bitシフト
<code>bitlen</code>が2の場合 -&gt; 4bitシフト
&hellip;
<code>(ash buf (- 6 bitlen))</code>
すればよさそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b1</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">1</span><span class="p">)))</span>
<span class="s">&#34;100000&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b01</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">2</span><span class="p">)))</span>
<span class="s">&#34;010000&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b010</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">3</span><span class="p">)))</span>
<span class="s">&#34;010000&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b0101</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">4</span><span class="p">)))</span>
<span class="s">&#34;010100&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b01011</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">5</span><span class="p">)))</span>
<span class="s">&#34;010110&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~6,&#39;0b&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="mb">#b010111</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="mi">6</span><span class="p">)))</span>
<span class="s">&#34;010111&#34;</span></code></pre></div>
<p>ok</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdefg&#34;</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
            <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                  <span class="nv">do</span>
                    <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                           <span class="c1">;; 先頭6ビット</span>
                           <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                      <span class="c1">;; 6ビット表示</span>
                      <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~6,&#39;0b(~d)~%&#34;</span> <span class="nv">6bit</span> <span class="nv">6bit</span><span class="p">)</span>
                      <span class="c1">;; 残り</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
            <span class="nv">finally</span>
              <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
              <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~6,&#39;0b[~d]~%&#34;</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">))</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))))</span>

<span class="mi">011000</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="mi">010110</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="mi">001001</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="mi">100011</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
<span class="mi">011001</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="mi">000110</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">010101</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="mi">100110</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span>
<span class="mi">011001</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="nv">110000[48]</span>
<span class="nv">NIL</span></code></pre></div>
<h2 id="数値を文字に変換したい">数値を文字に変換したい</h2>

<p>次はこれを文字列にします。
<code>0 -&gt; A</code>
<code>1 -&gt; B</code>
という変換なので配列を用意してそこに添え字えアクセスするような形式で取ってくれば良さそうです。 これは <code>aref</code> を使えばできます。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;abc&#34;</span> <span class="mi">0</span><span class="p">)</span>
<span class="sc">#\a</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;abc&#34;</span> <span class="mi">1</span><span class="p">)</span>
<span class="sc">#\b</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">flet</span> <span class="p">((</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-&#34;</span> <span class="nv">x</span><span class="p">)))</span>
           <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdefg&#34;</span><span class="p">)</span>
              <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
              <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
              <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                    <span class="nv">do</span>
                      <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                             <span class="c1">;; 先頭6ビット</span>
                             <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                        <span class="c1">;; 文字化</span>
                        <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~c&#34;</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="nv">6bit</span><span class="p">))</span>
                        <span class="c1">;; 残り</span>
                        <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                        <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
              <span class="nv">finally</span>
              <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
                <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;~c&#34;</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))))))</span>

<span class="nv">YWJjZGVmZw</span>
<span class="nv">NIL</span></code></pre></div>
<p>ここまで<code>format</code>で標準出力に出していたのですが値を保持するように修正します。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">flet</span> <span class="p">((</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-&#34;</span> <span class="nv">x</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">enc</span> <span class="o">&#39;</span><span class="p">()))</span>
    <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdefg&#34;</span><span class="p">)</span>
          <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
          <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
          <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                <span class="nv">do</span>
                  <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                         <span class="c1">;; 先頭6ビット</span>
                         <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                    <span class="c1">;; 文字化</span>
                    <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="nv">6bit</span><span class="p">)</span> <span class="nv">enc</span><span class="p">)</span>
                    <span class="c1">;; 残り</span>
                    <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                    <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
          <span class="nv">finally</span>
          <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
            <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))</span> <span class="nv">enc</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">nreverse</span> <span class="nv">enc</span><span class="p">)))</span></code></pre></div>
<h2 id="4文字区切りに対応させたい">4文字区切りに対応させたい</h2>

<p>base64エンコードは最後に4文字区切りにしてあまりを<code>=</code>で補うため、<code>YWJjZGVmZwはYWJjZGVmZw==</code>と補正されなくてはいけません。</p>

<p>このときは
- 1文字 -&gt; <code>===</code>
- 2文字 -&gt; <code>==</code>
- 3文字 -&gt; <code>=</code>
こうなってほしいです。</p>

<p>4で割ったあまりで4から引けば行けそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">1</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">3</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">2</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">2</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">1</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">4</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">4</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">0</span> <span class="mi">4</span><span class="p">))</span>
<span class="nv">4</span></code></pre></div>
<p>ああ、いけませんでした。0や4のときは0になってほしいのに4になってしまっています。 単純化しようとして失敗です。</p>

<p>じつは<code>mod</code>にマイナスを渡すとできたりします。
<a href="https://www.cs.cmu.edu/Groups/AI/html/hyperspec/HyperSpec/Body/funmodcmrem.html">https://www.cs.cmu.edu/Groups/AI/html/hyperspec/HyperSpec/Body/funmodcmrem.html</a></p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-1</span> <span class="mi">4</span><span class="p">)</span>
<span class="mi">3</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-2</span> <span class="mi">4</span><span class="p">)</span>
<span class="mi">2</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-3</span> <span class="mi">4</span><span class="p">)</span>
<span class="mi">1</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-0</span> <span class="mi">4</span><span class="p">)</span>
<span class="mi">0</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-4</span> <span class="mi">4</span><span class="p">)</span>
<span class="nv">0</span></code></pre></div>
<p>指定された回数分 <code>=</code> を表示してやればOKです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}&#34;</span> <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\=</span> <span class="sc">#\=</span><span class="p">))</span>
<span class="s">&#34;==&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}&#34;</span> <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="mi">3</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))</span>
<span class="s">&#34;===&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}&#34;</span> <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="p">(</span><span class="nv">mod</span> <span class="mi">-1</span> <span class="mi">4</span><span class="p">)</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))</span>
<span class="s">&#34;===&#34;</span></code></pre></div>
<p>こんな感じの関数になれば良さそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">lambda</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                               <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))))</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">funcall</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="nv">lambda</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
                      <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
                        <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                                   <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))))</span>
                  <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\a</span> <span class="sc">#\b</span> <span class="sc">#\c</span><span class="p">))</span>

<span class="s">&#34;abc=&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">funcall</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="nv">lambda</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
                      <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
                        <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                                   <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))))</span>
                  <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\a</span> <span class="sc">#\b</span> <span class="sc">#\c</span> <span class="sc">#\d</span><span class="p">))</span>

<span class="s">&#34;abcd&#34;</span>
<span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">funcall</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="nv">lambda</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
                      <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
                        <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                                   <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">))))</span>
                  <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\a</span> <span class="sc">#\b</span> <span class="sc">#\c</span> <span class="sc">#\d</span> <span class="sc">#\e</span><span class="p">))</span>

<span class="s">&#34;abcde===&#34;</span></code></pre></div>
<p>先ほどの処理に組み込みます</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">flet</span> <span class="p">((</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-&#34;</span> <span class="nv">x</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
           <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                      <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">enc</span> <span class="o">&#39;</span><span class="p">()))</span>
    <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdefg&#34;</span><span class="p">)</span>
          <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
          <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
          <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                <span class="nv">do</span>
                  <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                         <span class="c1">;; 先頭6ビット</span>
                         <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                    <span class="c1">;; 文字化</span>
                    <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="nv">6bit</span><span class="p">)</span> <span class="nv">enc</span><span class="p">)</span>
                    <span class="c1">;; 残り</span>
                    <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                    <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
          <span class="nv">finally</span>
          <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
            <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))</span> <span class="nv">enc</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">nreverse</span> <span class="nv">enc</span><span class="p">))))</span></code></pre></div>
<p>実行してみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">flet</span> <span class="p">((</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-&#34;</span> <span class="nv">x</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
                    <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                               <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">)))))</span>
           <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">enc</span> <span class="o">&#39;</span><span class="p">()))</span>
             <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="s">&#34;abcdefg&#34;</span><span class="p">)</span>
                <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
                <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
                <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                      <span class="nv">do</span>
                        <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                               <span class="c1">;; 先頭6ビット</span>
                               <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                          <span class="c1">;; 文字化</span>
                          <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="nv">6bit</span><span class="p">)</span> <span class="nv">enc</span><span class="p">)</span>
                          <span class="c1">;; 残り</span>
                          <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                          <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
                <span class="nv">finally</span>
                <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
                  <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))</span> <span class="nv">enc</span><span class="p">)))</span>
             <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">nreverse</span> <span class="nv">enc</span><span class="p">))))</span>

<span class="s">&#34;YWJjZGVmZw==&#34;</span></code></pre></div>
<p>よさそうです。</p>

<h2 id="関数にしたい">関数にしたい</h2>

<p>引数を<code>str</code>として関数にしてみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nv">defun</span> <span class="nv">base64-enc</span> <span class="p">(</span><span class="nv">str</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">flet</span> <span class="p">((</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
           <span class="p">(</span><span class="nv">aref</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-&#34;</span> <span class="nv">x</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">enc-list</span><span class="p">)</span>
           <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">pad-len</span> <span class="p">(</span><span class="nv">mod</span> <span class="p">(</span><span class="nv">-</span> <span class="p">(</span><span class="nv">length</span> <span class="nv">enc-list</span><span class="p">))</span> <span class="mi">4</span><span class="p">)))</span>
             <span class="p">(</span><span class="nv">format</span> <span class="no">nil</span> <span class="s">&#34;~{~C~}~{~C~}&#34;</span> <span class="nv">enc-list</span>
                                        <span class="p">(</span><span class="nv">make-sequence</span> <span class="ss">&#39;list</span> <span class="nv">pad-len</span> <span class="ss">:initial-element</span> <span class="sc">#\=</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">enc</span> <span class="o">&#39;</span><span class="p">()))</span>
      <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">ch</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">char-code</span> <span class="nv">str</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">buf</span> <span class="nv">=</span> <span class="nv">ch</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">logior</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="mi">8</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
            <span class="nv">for</span> <span class="nv">bitlen</span> <span class="nv">=</span> <span class="mi">8</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">+</span> <span class="nv">bitlen</span> <span class="mi">8</span><span class="p">)</span>
            <span class="nv">do</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="p">(</span><span class="nv">/</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">)</span>
                  <span class="nv">do</span>
                    <span class="p">(</span><span class="nv">let*</span> <span class="p">((</span><span class="nv">remain</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))</span>
                           <span class="c1">;; 先頭6ビット</span>
                           <span class="p">(</span><span class="nv">6bit</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">bitlen</span> <span class="nv">remain</span><span class="p">)</span> <span class="nv">buf</span><span class="p">)))</span>
                      <span class="c1">;; 文字化</span>
                      <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="nv">6bit</span><span class="p">)</span> <span class="nv">enc</span><span class="p">)</span>
                      <span class="c1">;; 残り</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">ldb</span> <span class="p">(</span><span class="nv">byte</span> <span class="nv">remain</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">buf</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">setf</span> <span class="nv">bitlen</span> <span class="p">(</span><span class="nv">-</span> <span class="nv">bitlen</span> <span class="mi">6</span><span class="p">))))</span>
            <span class="nv">finally</span>
            <span class="c1">;; あまりが発生したら末尾に0を埋めて6ビットにする</span>
              <span class="p">(</span><span class="nv">when</span> <span class="p">(</span><span class="nv">/=</span> <span class="nv">bitlen</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">push</span> <span class="p">(</span><span class="nv">to-enc</span> <span class="p">(</span><span class="nv">ash</span> <span class="nv">buf</span> <span class="p">(</span><span class="nv">-</span> <span class="mi">6</span> <span class="nv">bitlen</span><span class="p">)))</span> <span class="nv">enc</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="nv">nreverse</span> <span class="nv">enc</span><span class="p">)))))</span></code></pre></div>
<h2 id="ユニットテストをしたい">ユニットテストをしたい</h2>

<p>テストを書きます。
base64エンコードの結果は
<a href="https://www.base64encode.org/">https://www.base64encode.org/</a>
ここの結果を使っています。</p>

<p>まずは与える引数と期待する結果のリストです。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">setf</span> <span class="nv">test-list</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;a&#34;</span>       <span class="o">.</span> <span class="s">&#34;YQ==&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;ab&#34;</span>      <span class="o">.</span> <span class="s">&#34;YWI=&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;abc&#34;</span>     <span class="o">.</span> <span class="s">&#34;YWJj&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;abcd&#34;</span>    <span class="o">.</span> <span class="s">&#34;YWJjZA==&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;abcde&#34;</span>   <span class="o">.</span> <span class="s">&#34;YWJjZGU=&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;abcdef&#34;</span>  <span class="o">.</span> <span class="s">&#34;YWJjZGVm&#34;</span><span class="p">)</span>
                           <span class="p">(</span><span class="s">&#34;abcdefg&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJjZGVmZw==&#34;</span><span class="p">)))</span>

<span class="p">((</span><span class="s">&#34;a&#34;</span> <span class="o">.</span> <span class="s">&#34;YQ==&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;ab&#34;</span> <span class="o">.</span> <span class="s">&#34;YWI=&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;abc&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJj&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;abcd&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJjZA==&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;abcde&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJjZGU=&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;abcdef&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJjZGVm&#34;</span><span class="p">)</span> <span class="p">(</span><span class="s">&#34;abcdefg&#34;</span> <span class="o">.</span> <span class="s">&#34;YWJjZGVmZw==&#34;</span><span class="p">))</span></code></pre></div>
<p>こいつをループで回します。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="nv">CL-USER&gt;</span> <span class="p">(</span><span class="nv">loop</span> <span class="nv">for</span> <span class="p">(</span><span class="nv">arg</span> <span class="o">.</span> <span class="nv">expect</span><span class="p">)</span> <span class="nv">in</span> <span class="nv">test-list</span>
            <span class="nv">do</span>
              <span class="p">(</span><span class="nv">let</span> <span class="p">((</span><span class="nv">result</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nv">base64-enc</span> <span class="nv">arg</span><span class="p">)</span> <span class="nv">expect</span><span class="p">)))</span>
                <span class="p">(</span><span class="nv">format</span> <span class="no">t</span> <span class="s">&#34;testing  ~A -&gt; ~A ... ~:[NG~;OK~]~%&#34;</span> <span class="nv">arg</span> <span class="nv">expect</span> <span class="nv">result</span><span class="p">)))</span>

<span class="c1">;Compiler warnings :</span>
<span class="c1">;   In an anonymous lambda form: Undeclared free variable TEST-LIST</span>
<span class="nv">testing</span>  <span class="nv">a</span> <span class="nv">-&gt;</span> <span class="nv">YQ==</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">ab</span> <span class="nv">-&gt;</span> <span class="nv">YWI=</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">abc</span> <span class="nv">-&gt;</span> <span class="nv">YWJj</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">abcd</span> <span class="nv">-&gt;</span> <span class="nv">YWJjZA==</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">abcde</span> <span class="nv">-&gt;</span> <span class="nv">YWJjZGU=</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">abcdef</span> <span class="nv">-&gt;</span> <span class="nv">YWJjZGVm</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">testing</span>  <span class="nv">abcdefg</span> <span class="nv">-&gt;</span> <span class="nv">YWJjZGVmZw==</span> <span class="o">...</span> <span class="nv">OK</span>
<span class="nv">NIL</span></code></pre></div>
<p>すべてOKです。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2015/02/13/octopress/" class="left arrow">&#8592;</a>
		<a href="/posts/2015/02/14/octopress-to-ghost/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 22:08:13.876318 &#43;0900 JST m=&#43;0.443010519">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
