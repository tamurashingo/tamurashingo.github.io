<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Dropwizardでデータベースpart1 &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2015-06-10 20:54:50 &#43;0000 UTC">June 10, 2015</time>
</div>
		<h1 class="post-title">Dropwizardでデータベースpart1</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。</p>

<p>今回はDropwizardでデータベースを使ってみます。</p>

<!-- more -->

<h2 id="migration">Migration</h2>

<p>Migrationという仕組みを使ってデータベースを準備していきます。
Ruby on Railsとかのやつと同じです。</p>

<p><a href="https://dropwizard.github.io/dropwizard/manual/migrations.html">https://dropwizard.github.io/dropwizard/manual/migrations.html</a></p>

<p>以下の記述を<code>pom.xml</code>に追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>  
  <span class="nt">&lt;groupId&gt;</span>io.dropwizard<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>dropwizard-migrations<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${dropwizard.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>  
  <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>5.1.18<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>  </code></pre></div>
<h2 id="configuration">Configuration</h2>

<p>データベース関連の設定情報を外部ファイルから取得できるようにします。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Valid</span>
<span class="nd">@NotNull</span>
<span class="kd">private</span> <span class="n">DataSourceFactory</span> <span class="n">database</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataSourceFactory</span><span class="o">();</span>

<span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">&#34;database&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">DataSourceFactory</span> <span class="nf">getDataSourceFactory</span><span class="o">()</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="n">database</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
<p>設定ファイルにデータベース関連の情報を追加します。
データベースはMySQLを使います。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">database<span class="p">:</span><span class="w">  
</span><span class="w">  </span>driverClass<span class="p">:</span><span class="w"> </span>com.mysql.jdbc.Driver<span class="w">
</span><span class="w">  </span>user<span class="p">:</span><span class="w"> </span>root<span class="w">
</span><span class="w">  </span>password<span class="p">:</span><span class="w"> </span>password<span class="w">
</span><span class="w">  </span>url<span class="p">:</span><span class="w"> </span>jdbc<span class="p">:</span>mysql<span class="p">:</span>//localhost/helloworld<span class="p">?</span>useUnicode=<span class="kc">true</span><span class="cp">&amp;characterEncoding=utf8</span><span class="w">
</span><span class="w">  </span>properties<span class="p">:</span><span class="w">
</span><span class="w">    </span>charSet<span class="p">:</span><span class="w"> </span>UTF-<span class="m">8</span><span class="w">
</span><span class="w">  </span>maxWaitForConnection<span class="p">:</span><span class="w"> </span>1s<span class="w">
</span><span class="w">  </span>validationQuery<span class="p">:</span><span class="w"> </span><span class="s2">&#34;/* MyService Health Check */ SELECT 1&#34;</span><span class="w">
</span><span class="w">  </span>minSize<span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span><span class="w">  </span>maxSize<span class="p">:</span><span class="w"> </span><span class="m">32</span><span class="w">
</span><span class="w">  </span>checkConnectionWhileIdle<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span>evictionInterval<span class="p">:</span><span class="w"> </span>10s<span class="w">
</span><span class="w">  </span>minIdleTime<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>minute</code></pre></div>
<h2 id="application">Application</h2>

<p><code>initialize</code>メソッドを追加し、<code>MigrationBundle</code>を追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Bootstrap</span><span class="o">&lt;</span><span class="n">HelloWorldConfiguration</span><span class="o">&gt;</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">bootstrap</span><span class="o">.</span><span class="na">addBundle</span><span class="o">(</span><span class="k">new</span> <span class="n">MigrationsBundle</span><span class="o">&lt;</span><span class="n">HelloWorldConfiguration</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">DataSourceFactory</span> <span class="nf">getDataSourceFactory</span><span class="o">(</span><span class="n">HelloWorldConfiguration</span> <span class="n">configuration</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getDataSourceFactory</span><span class="o">();</span>
        <span class="o">}</span>
   <span class="o">});</span>
<span class="o">}</span></code></pre></div>
<h2 id="migrationの定義">Migrationの定義</h2>

<p><code>src/main/resources/migrations.xml</code>を作成し、そこにテーブル情報を追加していきます。 ここではサンプルと同じくxmlで定義します。</p>

<p>メッセージを格納するマスタの作成と、そのマスタの初期値を設定します。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>  
<span class="nt">&lt;databaseChangeLog</span>  
    <span class="na">xmlns=</span><span class="s">&#34;http://www.liquibase.org/xml/ns/dbchangelog&#34;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
    <span class="na">xsi:xsi:schemaLocation=</span><span class="s">&#34;http://www.liquibase.org/xml/ns/dbchangelog&#34;</span> <span class="err">&#34;http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&#34;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&#34;1&#34;</span> <span class="na">author=</span><span class="s">&#34;tamura.shingo&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;createTable</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">type=</span><span class="s">&#34;char(5)&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constraints</span> <span class="na">primaryKey=</span><span class="s">&#34;true&#34;</span> <span class="na">nullable=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/column&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">type=</span><span class="s">&#34;varchar(255)&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/createTable&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>

  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&#34;2&#34;</span> <span class="na">author=</span><span class="s">&#34;tamura.shingo&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00001&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;hello&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00002&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;こんにちは&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00003&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;bonjour&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>
<span class="nt">&lt;/databaseChangeLog&gt;</span>  </code></pre></div>
<h2 id="とりあえずマイグレーションの実行">とりあえずマイグレーションの実行</h2>

<p>ビルドした後に動かしてみます。</p>

<p>まずは差分の確認。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ java -jar target/helloworld-0.0.1-SNAPSHOT.jar db status hello-world.yml
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:44:25,176<span class="o">]</span> liquibase: Creating database <span class="nb">history</span> table with name: helloworld.DATABASECHANGELOG  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:44:25,675<span class="o">]</span> liquibase: Reading from helloworld.DATABASECHANGELOG  
<span class="m">2</span> change sets have not been applied to root@localhost@jdbc:mysql://localhost/helloworld?useUnicode<span class="o">=</span>true<span class="p">&amp;</span><span class="nv">characterEncoding</span><span class="o">=</span>utf8  </code></pre></div>
<p>2つ分当たっていないと仰っています。</p>

<p>当てます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ java -jar target/helloworld-0.0.1-SNAPSHOT.jar db migrate hello-world.yml
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:01,115<span class="o">]</span> liquibase: Successfully acquired change log lock  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,233<span class="o">]</span> liquibase: Reading from helloworld.DATABASECHANGELOG  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,343<span class="o">]</span> liquibase: migrations.xml: <span class="m">1</span>::tamura.shingo: Table m_message created  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,343<span class="o">]</span> liquibase: migrations.xml: <span class="m">1</span>::tamura.shingo: ChangeSet migrations.xml::1::tamura.shingo ran successfully in 103ms  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,397<span class="o">]</span> liquibase: migrations.xml: <span class="m">2</span>::tamura.shingo: New row inserted into m_message  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,398<span class="o">]</span> liquibase: migrations.xml: <span class="m">2</span>::tamura.shingo: New row inserted into m_message  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,399<span class="o">]</span> liquibase: migrations.xml: <span class="m">2</span>::tamura.shingo: New row inserted into m_message  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,401<span class="o">]</span> liquibase: migrations.xml: <span class="m">2</span>::tamura.shingo: ChangeSet migrations.xml::2::tamura.shingo ran successfully in 26ms  
INFO  <span class="o">[</span><span class="m">2015</span>-06-10 <span class="m">11</span>:46:02,685<span class="o">]</span> liquibase: Successfully released change log lock  </code></pre></div>
<p>当たりました。</p>

<p>確認してみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">tables</span><span class="p">;</span>  
<span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">Tables_in_helloworld</span>  <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">databasechangelog</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">databasechangeloglock</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">m_message</span>             <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">m_message</span><span class="p">;</span>  
<span class="o">+</span><span class="c1">-------+------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="n">message</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------------+
</span><span class="c1"></span><span class="o">|</span> <span class="mi">00001</span> <span class="o">|</span> <span class="n">hello</span>      <span class="o">|</span>
<span class="o">|</span> <span class="mi">00002</span> <span class="o">|</span> <span class="err">こんにちは</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">00003</span> <span class="o">|</span> <span class="n">bonjour</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------------+
</span><span class="c1"></span><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>  </code></pre></div>
<p>テーブルが作られて初期値がセットされています。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2015/06/10/dropwizard/" class="left arrow">&#8592;</a>
		<a href="/posts/2015/06/12/dropwizard-database-2/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 21:56:01.441002 &#43;0900 JST m=&#43;0.527331749">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
