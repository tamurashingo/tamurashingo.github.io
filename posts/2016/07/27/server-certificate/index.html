<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				サーバ証明書(オレオレ証明書)を作る &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2016-07-27 02:19:37 &#43;0000 UTC">July 27, 2016</time>
</div>
		<h1 class="post-title">サーバ証明書(オレオレ証明書)を作る</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。</p>

<p>前回、OpenSSLでオレオレ認証局を作りました。
今回はOpenSSLでサーバ証明書要求を作って、 オレオレ認証局に署名してもらう一連の手順をやっていきます。</p>

<p>最終的にApacheに組み込みます。</p>

<!-- more -->

<h2 id="秘密鍵の作成">秘密鍵の作成</h2>

<p>秘密鍵はパスワードで保護されます。
わかりやすいように、サーバ名や年度をファイル名に入れておきます。</p>

<p>参考
<a href="https://jp.globalsign.com/support/csr/04.html?service=ssl">https://jp.globalsign.com/support/csr/04.html?service=ssl</a></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># mkdir /etc/pki/ssl</span>
<span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># cd /etc/pki/ssl</span>
<span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># openssl genrsa -out www2.il-sus-web.net.2016.key -aes256 2048</span>
Generating RSA private key, <span class="m">2048</span> bit long modulus
...................................................+++
...........................................................................................................................................+++
e is <span class="m">65537</span> <span class="o">(</span>0x10001<span class="o">)</span>
Enter pass phrase <span class="k">for</span> www2.il-sus-web.net.2016.key:<span class="o">(</span>秘密鍵のパスワードを設定する<span class="o">)</span>
Verifying - Enter pass phrase <span class="k">for</span> www2.il-sus-web.net.2016.key:<span class="o">(</span>確認<span class="o">)</span></code></pre></div>
<h2 id="証明書署名要求-csr-certificate-signing-request-の作成">証明書署名要求(CSR Certificate Signing Request)の作成</h2>

<p>CSRを作ります。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># openssl req -new -key www2.il-sus-web.net.2016.key -out www2.il-sus-web.net.2016.csr</span>
Enter pass phrase <span class="k">for</span> www2.il-sus-web.net.2016.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
-----
Country Name <span class="o">(</span><span class="m">2</span> letter code<span class="o">)</span> <span class="o">[</span>XX<span class="o">]</span>:JP
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[]</span>:Tokyo
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>Default City<span class="o">]</span>:Shinjuku
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Default Company Ltd<span class="o">]</span>:il-sus-web
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[]</span>:
Common Name <span class="o">(</span>eg, your name or your server<span class="s1">&#39;s hostname) []:www2.il-sus-web.net
</span><span class="s1">Email Address []:xxxxxxxxxx
</span><span class="s1">
</span><span class="s1">Please enter the following &#39;</span>extra<span class="err">&#39;</span> attributes
to be sent with your certificate request
A challenge password <span class="o">[]</span>:
An optional company name <span class="o">[]</span>:</code></pre></div>
<h2 id="ca-オレオレ認証局-による署名">CA(オレオレ認証局)による署名</h2>

<p>以前作成したオレオレ認証局で署名を行います。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># openssl ca -in /etc/pki/ssl/www2.il-sus-web.net.2016.csr -keyfile /etc/pki/CA/private/cakey.pem -cert /etc/pki/CA/cacert.pem -out www2.il-sus-web.net.2016.crt</span>
Using configuration from /etc/pki/tls/openssl.cnf
Enter pass phrase <span class="k">for</span> /etc/pki/CA/private/cakey.pem:<span class="o">(</span>オレオレ認証局を作った時のパスワード<span class="o">)</span>
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span class="m">15711698583568785532</span> <span class="o">(</span>0xda0b2a9e1ba0207c<span class="o">)</span>
        Validity
            Not Before: Jul <span class="m">26</span> <span class="m">16</span>:42:49 <span class="m">2016</span> GMT
            Not After : Jul <span class="m">26</span> <span class="m">16</span>:42:49 <span class="m">2017</span> GMT
        Subject:
            <span class="nv">countryName</span>               <span class="o">=</span> JP
            <span class="nv">stateOrProvinceName</span>       <span class="o">=</span> Tokyo
            <span class="nv">organizationName</span>          <span class="o">=</span> il-sus-web
            <span class="nv">commonName</span>                <span class="o">=</span> www2.il-sus-web.net
            <span class="nv">emailAddress</span>              <span class="o">=</span> xxxxxxxxxxxxxxxx
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                F0:83:63:98:50:90:26:A4:4B:4A:75:6C:22:9D:B7:E3:4B:48:E9:D8
            X509v3 Authority Key Identifier: 
                keyid:65:2D:A0:29:6D:29:7B:B7:FD:F7:25:D7:87:78:3F:F9:26:CE:5E:16

Certificate is to be certified <span class="k">until</span> Jul <span class="m">26</span> <span class="m">16</span>:42:49 <span class="m">2017</span> GMT <span class="o">(</span><span class="m">365</span> days<span class="o">)</span>
Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y


<span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
Write out database with <span class="m">1</span> new entries
Data Base Updated</code></pre></div>
<p>確認してみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># ls</span>
www2.il-sus-web.net.2016.crt  www2.il-sus-web.net.2016.csr  www2.il-sus-web.net.2016.key</code></pre></div>
<p>できました。</p>

<h2 id="apacheへの組み込み">Apacheへの組み込み</h2>

<p>できあがった</p>

<ul>
<li>/etc/pki/ssl/www2.il-sus-web.net.2016.key</li>
<li>/etc/pki/ssl/www2.il-sus-web.net.2016.crt</li>
</ul>

<p>をApacheに設定します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># vi /etc/httpd/conf.d/ssl.conf</span></code></pre></div>
<p>以下のように既存の行をコメントアウトして、今回生成したファイルを設定します。</p>

<pre><code>#SSLCertificateFile /etc/pki/tls/certs/localhost.crt&lt;/span&gt;
SSLCertificateFile /etc/pki/ssl/www2.il-sus-web.net.2016.crt

#SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
SSLCertificateKeyFile /etc/pki/ssl/www2.il-sus-web.net.2016.key
</code></pre>

<p>設定が終わったらApacheを再起動します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@il-sus-web-www2 ssl<span class="o">]</span><span class="c1"># service httpd restart</span>
Redirecting to /bin/systemctl restart  httpd.service
Enter SSL pass phrase <span class="k">for</span> xxx.xxx.xxx.xxx:443 <span class="o">(</span>RSA<span class="o">)</span> : ****************</code></pre></div>
<p>途中で秘密鍵のパスワードが聞かれるので答えておきます。
これで https でアクセスできるようになりました。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2016/07/23/write-blog-with-markdown/" class="left arrow">&#8592;</a>
		<a href="/posts/2016/07/28/client-authentication/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 21:56:01.43456 &#43;0900 JST m=&#43;0.520890670">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
