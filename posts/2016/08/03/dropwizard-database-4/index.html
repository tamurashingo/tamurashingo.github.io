<!DOCTYPE html>
<html lang="ja-jp">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Dropwizardでデータベースpart4 &middot; Web技術と親しむ
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Web技術と親しむ" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Web技術と親しむ</h2>
				</a>
				<ul>
    <li><a href="/about">About</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2016-08-03 22:06:15 &#43;0000 UTC">August 3, 2016</time>
</div>
		<h1 class="post-title">Dropwizardでデータベースpart4</h1>
<div class="post-line"></div>

		


		

<p>tamuraです。
今回はDropwizardで複数のDAOを使った場合のトランザクション制御をやって行きます。</p>

<ul>
<li><a href="/posts/2015/06/10/dropwizard/">Dropwizardを使ってみる</a></li>
<li><a href="/posts/2015/06/10/dropwizard-database-1/">Dropwizardでデータベースpart1</a></li>
<li><a href="/posts/2015/06/12/dropwizard-database-2/">Dropwizardでデータベースpart2</a></li>
<li><a href="/posts/2015/06/13/dropwizard-database-3/">Dropwizardでデータベースpart3</a></li>
</ul>

<!-- more -->

<h2 id="構成の変更">構成の変更</h2>

<h3 id="abstractdaoの作成">AbstractDAOの作成</h3>

<p>DAOの中で別のDAOを生成できるように、基底クラスを作ります。
またトランザクション制御を行えるようにしてあります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.CreateSqlObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.mixins.Transactional</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractDAO</span> <span class="kd">implements</span> <span class="n">Transactional</span><span class="o">&lt;</span><span class="n">AbstractDAO</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@CreateSqlObject</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">MessageDAO</span> <span class="nf">createMessageDAO</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>
<h3 id="messagedaoの変更">MessageDAOの変更</h3>

<p>今まであった<code>MessageDAO</code>を<code>interface</code>から<code>abstract class</code>に変更します。
あと、今まで実装(?)は<code>MessageDAOMySQLImpl</code>で行っていたのですが、ちょっとうまくできなかったのでこのクラスでSQLを実装しています。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.Bind</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.SqlQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.SqlUpdate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.customizers.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.customizers.SingleValueResult</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.Saying</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.dao.mapper.SayingMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.common.base.Optional</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">MessageDAO</span> <span class="kd">extends</span> <span class="n">AbstractDAO</span> <span class="o">{</span>

    <span class="nd">@SingleValueResult</span><span class="o">(</span><span class="n">Saying</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@SqlQuery</span><span class="o">(</span>
              <span class="s">&#34; select &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   message &#34;</span>
            <span class="o">+</span> <span class="s">&#34; from &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   m_message &#34;</span>
            <span class="o">+</span> <span class="s">&#34; where &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   id = :messageId &#34;</span>
    <span class="o">)</span>
    <span class="nd">@Mapper</span><span class="o">(</span><span class="n">SayingMapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Saying</span><span class="o">&gt;</span> <span class="nf">getMessage</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;messageId&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">messageId</span><span class="o">);</span>

    <span class="nd">@SqlUpdate</span><span class="o">(</span>
              <span class="s">&#34; update &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   m_message &#34;</span>
            <span class="o">+</span> <span class="s">&#34; set &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   message = :message &#34;</span>
            <span class="o">+</span> <span class="s">&#34; where &#34;</span>
            <span class="o">+</span> <span class="s">&#34;   id = :messageId &#34;</span>
    <span class="o">)</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">updateMessage</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;messageId&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">messageId</span><span class="o">,</span> <span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">message</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>
<h3 id="helloworldresourceの変更">HelloWorldResourceの変更</h3>

<p>まずはコンストラクタで<code>AbstractDAO</code>を受け取ります。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Path</span><span class="o">(</span><span class="s">&#34;/hello-world&#34;</span><span class="o">)</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldResource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">AbstractDAO</span> <span class="n">dao</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Saying</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Saying</span><span class="o">(</span><span class="s">&#34;hello world&#34;</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nf">HelloWorldResource</span><span class="o">(</span><span class="n">AbstractDAO</span> <span class="n">dao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dao</span> <span class="o">=</span> <span class="n">dao</span><span class="o">;</span>
    <span class="o">}</span></code></pre></div>
<p>つぎに<code>sayHello</code>メソッドを変更します。
今まで<code>MessageDAO</code>をそのまま使っていましたが、<code>AbstractDAO#createMessageDAO</code>で<code>MessageDAO</code>を生成するようにします。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="n">Saying</span> <span class="nf">sayHello</span><span class="o">(</span><span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&#34;messageid&#34;</span><span class="o">)</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">messageId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">messageId</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">MessageDAO</span> <span class="n">messageDAO</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">createMessageDAO</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">messageDAO</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">messageId</span><span class="o">.</span><span class="na">get</span><span class="o">()).</span><span class="na">or</span><span class="o">(</span><span class="n">defaultValue</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">defaultValue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>
<p><code>updateHello</code>も同じように変更します。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@POST</span>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Saying</span> <span class="nf">updateHello</span><span class="o">(</span><span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">formParams</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">formParams</span><span class="o">.</span><span class="na">getFirst</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">);</span>

        <span class="n">dao</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="k">new</span> <span class="n">Transaction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">AbstractDAO</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Void</span> <span class="nf">inTransaction</span><span class="o">(</span><span class="n">AbstractDAO</span> <span class="n">transactional</span><span class="o">,</span> <span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="n">transactional</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
                <span class="n">MessageDAO</span> <span class="n">messageDAO</span> <span class="o">=</span> <span class="n">transactional</span><span class="o">.</span><span class="na">createMessageDAO</span><span class="o">();</span>
                <span class="n">messageDAO</span><span class="o">.</span><span class="na">updateMessage</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
                <span class="n">transactional</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="k">return</span> <span class="n">sayHello</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">));</span>
    <span class="o">}</span></code></pre></div>
<h3 id="helloworldapplicationの変更">HelloWorldApplicationの変更</h3>

<p><code>HelloWorldResource</code>の呼び出し方を変更します。
具体的には<code>AbstractDAO</code>を渡すように変更しています。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">HelloWorldConfiguration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">DBIFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DBIFactory</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">DBI</span> <span class="n">jdbi</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getDataSourceFactory</span><span class="o">(),</span> <span class="s">&#34;helloworlddb&#34;</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">AbstractDAO</span> <span class="n">dao</span> <span class="o">=</span> <span class="n">jdbi</span><span class="o">.</span><span class="na">onDemand</span><span class="o">(</span><span class="n">AbstractDAO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">environment</span><span class="o">.</span><span class="na">jersey</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloWorldResource</span><span class="o">(</span><span class="n">dao</span><span class="o">));</span>
    <span class="o">}</span></code></pre></div>
<p>これで実行すると、<a href="/posts/2015/06/13/dropwizard-database-3/">前回</a>と同じ結果が得られます。</p>

<h2 id="テーブルの追加">テーブルの追加</h2>

<p>migrations.xmlを使ってテーブルを追加します。
<code>M_MESSAGE</code>を更新した際にバックアップを格納するテーブルです。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;databaseChangeLog</span>
    <span class="na">xmlns=</span><span class="s">&#34;http://www.liquibase.org/xml/ns/dbchangelog&#34;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&#34;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&#34;1&#34;</span> <span class="na">author=</span><span class="s">&#34;tamura.shingo&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;createTable</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">type=</span><span class="s">&#34;char(5)&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constraints</span> <span class="na">primaryKey=</span><span class="s">&#34;true&#34;</span> <span class="na">nullable=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/column&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">type=</span><span class="s">&#34;varchar(255)&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/createTable&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>

  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&#34;2&#34;</span> <span class="na">author=</span><span class="s">&#34;tamura.shingo&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00001&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;hello&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00002&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;こんにちは&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">tableName=</span><span class="s">&#34;m_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">value=</span><span class="s">&#34;00003&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">value=</span><span class="s">&#34;bonjour&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>

  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&#34;3&#34;</span> <span class="na">author=</span><span class="s">&#34;tamura.shingo&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;createTable</span> <span class="na">tableName=</span><span class="s">&#34;h_message&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;history_id&#34;</span> <span class="na">type=</span><span class="s">&#34;BIGINT&#34;</span> <span class="na">autoIncrement=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constraints</span> <span class="na">primaryKey=</span><span class="s">&#34;true&#34;</span> <span class="na">nullable=</span><span class="s">&#34;false&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/column&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;id&#34;</span> <span class="na">type=</span><span class="s">&#34;char(5)&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;message&#34;</span> <span class="na">type=</span><span class="s">&#34;varchar(255)&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&#34;updateDate&#34;</span> <span class="na">type=</span><span class="s">&#34;datetime&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/createTable&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>
<span class="nt">&lt;/databaseChangeLog&gt;</span></code></pre></div>
<p>これをマイグレーションします。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ java -jar target/helloworld-0.0.1-SNAPSHOT.jar db migrate hello-world.yml
INFO  <span class="o">[</span><span class="m">2015</span>-06-12 <span class="m">15</span>:16:17,876<span class="o">]</span> liquibase: Successfully acquired change log lock
INFO  <span class="o">[</span><span class="m">2015</span>-06-12 <span class="m">15</span>:16:18,351<span class="o">]</span> liquibase: Reading from helloworld.DATABASECHANGELOG
INFO  <span class="o">[</span><span class="m">2015</span>-06-12 <span class="m">15</span>:16:18,384<span class="o">]</span> liquibase: migrations.xml: <span class="m">3</span>::tamura.shingo: Table h_message created
INFO  <span class="o">[</span><span class="m">2015</span>-06-12 <span class="m">15</span>:16:18,385<span class="o">]</span> liquibase: migrations.xml: <span class="m">3</span>::tamura.shingo: ChangeSet migrations.xml::3::tamura.shingo ran successfully in 9ms
INFO  <span class="o">[</span><span class="m">2015</span>-06-12 <span class="m">15</span>:16:18,395<span class="o">]</span> liquibase: Successfully released change log lock</code></pre></div>
<h2 id="daoの追加">DAOの追加</h2>

<p>この<code>H_MESSAGE</code>を処理するDAOを作っていきます。
こんな感じです。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.Bind</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.SqlUpdate</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">HistoryDAO</span> <span class="kd">extends</span> <span class="n">AbstractDAO</span> <span class="o">{</span>

    <span class="nd">@SqlUpdate</span><span class="o">(</span>
            <span class="s">&#34; insert into &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   h_message &#34;</span>
          <span class="o">+</span> <span class="s">&#34; ( &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   id, &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   message, &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   updateDate &#34;</span>
          <span class="o">+</span> <span class="s">&#34; ) &#34;</span>
          <span class="o">+</span> <span class="s">&#34; values ( &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   :messageId, &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   :message, &#34;</span>
          <span class="o">+</span> <span class="s">&#34;   now() &#34;</span>
          <span class="o">+</span> <span class="s">&#34; ) &#34;</span>
    <span class="o">)</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">backupMessage</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;messageId&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">messageId</span><span class="o">,</span> <span class="nd">@Bind</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">message</span><span class="o">);</span>

<span class="o">}</span></code></pre></div>
<p>また、<code>AbstractDAO</code>にこの<code>HistoryDAO</code>を生成する処理を追加しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.github.tamurashingo.dropwizard.helloworld.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.CreateSqlObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.skife.jdbi.v2.sqlobject.mixins.Transactional</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractDAO</span> <span class="kd">implements</span> <span class="n">Transactional</span><span class="o">&lt;</span><span class="n">AbstractDAO</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@CreateSqlObject</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">MessageDAO</span> <span class="nf">createMessageDAO</span><span class="o">();</span>

    <span class="nd">@CreateSqlObject</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">HistoryDAO</span> <span class="nf">createHistoryDAO</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>
<h2 id="メインロジック">メインロジック</h2>

<p>以下の要領で作っていきます。</p>

<ul>
<li><code>00001</code>の<code>message</code>を更新</li>
<li><code>m_message</code>に既存の値があった場合は、<code>h_message</code>に入れる</li>
<li><code>exception</code>という更新値がきた場合は例外を発生させる(rollbackの確認用)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@POST</span>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Saying</span> <span class="nf">updateHello</span><span class="o">(</span><span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">formParams</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">formParams</span><span class="o">.</span><span class="na">getFirst</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">);</span>

        <span class="n">dao</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="k">new</span> <span class="n">Transaction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">AbstractDAO</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Void</span> <span class="nf">inTransaction</span><span class="o">(</span><span class="n">AbstractDAO</span> <span class="n">transactional</span><span class="o">,</span> <span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="n">transactional</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
                <span class="n">MessageDAO</span> <span class="n">messageDAO</span> <span class="o">=</span> <span class="n">transactional</span><span class="o">.</span><span class="na">createMessageDAO</span><span class="o">();</span>
                <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Saying</span><span class="o">&gt;</span> <span class="n">oldMessage</span> <span class="o">=</span> <span class="n">messageDAO</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">oldMessage</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Saying</span> <span class="n">oldMessageContent</span> <span class="o">=</span> <span class="n">oldMessage</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                    <span class="n">HistoryDAO</span> <span class="n">historyDAO</span> <span class="o">=</span> <span class="n">transactional</span><span class="o">.</span><span class="na">createHistoryDAO</span><span class="o">();</span>
                    <span class="n">historyDAO</span><span class="o">.</span><span class="na">backupMessage</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">,</span> <span class="n">oldMessageContent</span><span class="o">.</span><span class="na">getGreeting</span><span class="o">());</span>
                <span class="o">}</span>

                <span class="n">messageDAO</span><span class="o">.</span><span class="na">updateMessage</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">Objects</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="s">&#34;exception&#34;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="s">&#34;このタイミングで例外かよ。。。。&#34;</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">transactional</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="k">return</span> <span class="n">sayHello</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;00001&#34;</span><span class="o">));</span>
    <span class="o">}</span></code></pre></div>
<p>これで完成です。</p>

<h2 id="実行">実行</h2>

<p>起動します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ java -jar target/helloworld-0.0.1-SNAPSHOT.jar server hello-world.yml
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:58,904<span class="o">]</span> org.eclipse.jetty.util.log: Logging initialized @798ms
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,032<span class="o">]</span> io.dropwizard.server.ServerFactory: Starting HelloWorldApplication
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,073<span class="o">]</span> org.eclipse.jetty.setuid.SetUIDListener: Opened application@ab7a938<span class="o">{</span>HTTP/1.1<span class="o">}{</span><span class="m">0</span>.0.0.0:8080<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,074<span class="o">]</span> org.eclipse.jetty.setuid.SetUIDListener: Opened admin@3faf2e7d<span class="o">{</span>HTTP/1.1<span class="o">}{</span><span class="m">0</span>.0.0.0:8081<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,076<span class="o">]</span> org.eclipse.jetty.server.Server: jetty-9.2.z-SNAPSHOT
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,674<span class="o">]</span> io.dropwizard.jersey.DropwizardResourceConfig: The following paths were found <span class="k">for</span> the configured resources:

    GET     /hello-world <span class="o">(</span>com.github.tamurashingo.dropwizard.helloworld.HelloWorldResource<span class="o">)</span>
    POST    /hello-world <span class="o">(</span>com.github.tamurashingo.dropwizard.helloworld.HelloWorldResource<span class="o">)</span>

INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,678<span class="o">]</span> org.eclipse.jetty.server.handler.ContextHandler: Started i.d.j.MutableServletContextHandler@359b650b<span class="o">{</span>/,null,AVAILABLE<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,683<span class="o">]</span> io.dropwizard.setup.AdminEnvironment: <span class="nv">tasks</span> <span class="o">=</span>

    POST    /tasks/log-level <span class="o">(</span>io.dropwizard.servlets.tasks.LogConfigurationTask<span class="o">)</span>
    POST    /tasks/gc <span class="o">(</span>io.dropwizard.servlets.tasks.GarbageCollectionTask<span class="o">)</span>

INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,687<span class="o">]</span> org.eclipse.jetty.server.handler.ContextHandler: Started i.d.j.MutableServletContextHandler@46d9aec8<span class="o">{</span>/,null,AVAILABLE<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,739<span class="o">]</span> org.eclipse.jetty.server.ServerConnector: Started application@ab7a938<span class="o">{</span>HTTP/1.1<span class="o">}{</span><span class="m">0</span>.0.0.0:8080<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,752<span class="o">]</span> org.eclipse.jetty.server.ServerConnector: Started admin@3faf2e7d<span class="o">{</span>HTTP/1.1<span class="o">}{</span><span class="m">0</span>.0.0.0:8081<span class="o">}</span>
INFO  <span class="o">[</span><span class="m">2016</span>-07-13 <span class="m">17</span>:48:59,752<span class="o">]</span> org.eclipse.jetty.server.Server: Started @1647ms</code></pre></div>
<h3 id="更新">更新</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -d <span class="nv">message</span><span class="o">=</span>GoodAfternoon -i -L http://localhost:8080/hello-world
HTTP/1.1 <span class="m">200</span> OK
Date: Wed, <span class="m">13</span> Jul <span class="m">2016</span> <span class="m">17</span>:51:48 GMT
Content-Type: application/json
Content-Length: <span class="m">28</span>

<span class="o">{</span><span class="s2">&#34;greeting&#34;</span>:<span class="s2">&#34;GoodAfternoon&#34;</span><span class="o">}</span></code></pre></div>
<h4 id="ログ">ログ</h4>

<pre><code>0:0:0:0:0:0:0:1 - - [13/7/2016:17:51:48 +0000] &quot;POST /hello-world HTTP/1.1&quot; 200 28 &quot;-&quot; &quot;curl/7.30.0&quot; 10
</code></pre>

<h4 id="mysql">MySQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">m_message</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="n">message</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="o">|</span> <span class="mi">00001</span> <span class="o">|</span> <span class="n">GoodAfternoon</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">00002</span> <span class="o">|</span> <span class="err">こんにちは</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">00003</span> <span class="o">|</span> <span class="n">bonjour</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">h_message</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">history_id</span> <span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="n">message</span> <span class="o">|</span> <span class="n">updateDate</span>          <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="o">|</span>          <span class="mi">1</span> <span class="o">|</span> <span class="mi">00001</span> <span class="o">|</span> <span class="n">hello</span>   <span class="o">|</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">14</span> <span class="mi">02</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span></code></pre></div>
<h3 id="例外発生">例外発生</h3>

<p><code>exception</code>というキーワードを与えて、内部で例外を発生させてみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -d <span class="nv">message</span><span class="o">=</span>exception -i -L http://localhost:8080/hello-world
HTTP/1.1 <span class="m">500</span> Internal Server Error
Date: Wed, <span class="m">13</span> Jul <span class="m">2016</span> <span class="m">17</span>:53:12 GMT
Content-Type: application/json
Content-Length: <span class="m">110</span>

<span class="o">{</span><span class="s2">&#34;code&#34;</span>:500,<span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;There was an error processing your request. It has been logged (ID 1cf9824636cfbf6c).&#34;</span><span class="o">}</span></code></pre></div>
<h4 id="ログ-1">ログ</h4>

<pre><code>0:0:0:0:0:0:0:1 - - [13/7/2016:17:53:12 +0000] &quot;POST /hello-world HTTP/1.1&quot; 500 110 &quot;-&quot; &quot;curl/7.30.0&quot; 11
ERROR [2016-07-13 17:53:12,657] io.dropwizard.jersey.errors.LoggingExceptionMapper: Error handling a request: 1cf9824636cfbf6c
! java.lang.Exception: このタイミングで例外かよ。。。。
! at com.github.tamurashingo.dropwizard.helloworld.HelloWorldResource$1.inTransaction(HelloWorldResource.java:66) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at com.github.tamurashingo.dropwizard.helloworld.HelloWorldResource$1.inTransaction(HelloWorldResource.java:50) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.sqlobject.InTransactionHandler$1.inTransaction(InTransactionHandler.java:37) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.tweak.transactions.LocalTransactionHandler.inTransaction(LocalTransactionHandler.java:184) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! ... 62 common frames omitted
! Causing: org.skife.jdbi.v2.exceptions.TransactionFailedException: Transaction failed do to exception being thrown from within the callback. See cause for the original exception.
! at org.skife.jdbi.v2.tweak.transactions.LocalTransactionHandler.inTransaction(LocalTransactionHandler.java:195) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.BasicHandle.inTransaction(BasicHandle.java:327) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.sqlobject.InTransactionHandler.invoke(InTransactionHandler.java:32) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.sqlobject.SqlObject.invoke(SqlObject.java:175) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.skife.jdbi.v2.sqlobject.SqlObject$1.intercept(SqlObject.java:75) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at com.github.tamurashingo.dropwizard.helloworld.dao.AbstractDAO$$EnhancerByCGLIB$$631a84fe.inTransaction(&lt;generated&gt;) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at com.github.tamurashingo.dropwizard.helloworld.HelloWorldResource.updateHello(HelloWorldResource.java:50) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_31]
! at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_31]
! at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_31]
! at java.lang.reflect.Method.invoke(Method.java:483) ~[na:1.8.0_31]
! at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory$1.invoke(ResourceMethodInvocationHandlerFactory.java:81) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:164) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:181) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$TypeOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:203) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:101) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:389) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:347) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:102) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:305) ~[helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.internal.Errors$1.call(Errors.java:271) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.internal.Errors$1.call(Errors.java:267) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.internal.Errors.process(Errors.java:315) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.internal.Errors.process(Errors.java:297) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.internal.Errors.process(Errors.java:267) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:317) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:288) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1110) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:401) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:386) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:335) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:222) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.jetty.NonblockingServletHolder.handle(NonblockingServletHolder.java:49) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1669) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:300) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.jetty.BiDiGzipFilter.doFilter(BiDiGzipFilter.java:134) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.servlets.ThreadNameFilter.doFilter(ThreadNameFilter.java:29) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.jersey.filter.AllowedMethodsFilter.handle(AllowedMethodsFilter.java:44) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.jersey.filter.AllowedMethodsFilter.doFilter(AllowedMethodsFilter.java:39) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at com.codahale.metrics.jetty9.InstrumentedHandler.handle(InstrumentedHandler.java:240) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at io.dropwizard.jetty.RoutingHandler.handle(RoutingHandler.java:51) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.RequestLogHandler.handle(RequestLogHandler.java:95) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:159) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.Server.handle(Server.java:497) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555) [helloworld-0.0.1-SNAPSHOT.jar:na]
! at java.lang.Thread.run(Thread.java:745) [na:1.8.0_31]
</code></pre>

<h4 id="mysql-1">MySQL</h4>

<p>ちゃんとrollbackされていました。</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">m_message</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="n">message</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="o">|</span> <span class="mi">00001</span> <span class="o">|</span> <span class="n">GoodAfternoon</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">00002</span> <span class="o">|</span> <span class="err">こんにちは</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">00003</span> <span class="o">|</span> <span class="n">bonjour</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-------+---------------+
</span><span class="c1"></span><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">h_message</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">history_id</span> <span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="n">message</span> <span class="o">|</span> <span class="n">updateDate</span>          <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="o">|</span>          <span class="mi">1</span> <span class="o">|</span> <span class="mi">00001</span> <span class="o">|</span> <span class="n">hello</span>   <span class="o">|</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">14</span> <span class="mi">02</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+-------+---------+---------------------+
</span><span class="c1"></span><span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span></code></pre></div>
<h2 id="まとめ">まとめ</h2>

<p>以下の方法でDropwizard JDBIで複数のDAOを扱うことができました。</p>

<ul>
<li><code>AbstractDAO</code>で各DAOを生成するメソッドを宣言する</li>
<li>各DAOは<code>AbstractDAO</code>を基底クラスにする</li>
</ul>


		
	</div>

	<div class="pagination">
		<a href="/posts/2016/08/02/markdown-syntaxhightlight/" class="left arrow">&#8592;</a>
		<a href="/posts/2016/08/10/install-android-studio-on-ubuntu1404/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-04-16 22:08:13.852871 &#43;0900 JST m=&#43;0.419563677">2019</time> tamura shingo. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
